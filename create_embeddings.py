import numpy as np
import psycopg2
from langchain_core.documents import Document
from promptflow import tool
from psycopg2.extensions import register_adapter, AsIs
from sentence_transformers import SentenceTransformer


def adapt_numpy_array(numpy_array):
    return AsIs(tuple(numpy_array))


register_adapter(np.ndarray, adapt_numpy_array)

model = SentenceTransformer('sentence-transformers/all-MiniLM-L12-v2')


@tool
def create_embeddings(chunks: list[Document]):
    embeddings = model.encode(list(map(lambda chunk: chunk.page_content, chunks)))

    query = model.encode("How much does a transfer cost ?")
    query_string = '[' + ','.join(map(str, query)) + ']'
    print(f"Query vector: {query_string}")

    conn = psycopg2.connect("host=localhost dbname=postgres user=postgres password=postgres")

    cur = conn.cursor()

    for document, embedding in zip(chunks, embeddings):
        embedding_text = '[' + ','.join(map(str, embedding)) + ']'

        cur.execute('INSERT INTO embeddings (title, chunk, embedding) VALUES (%s, %s, %s)',
                    (document.metadata['Question'],
                     document.page_content,
                     embedding_text))

    conn.commit()
    cur.close()
    conn.close()

    # SELECT title, 1-(embedding <=> '[0.045920044,-0.03423682,-0.05681318,0.022147665,-0.030016566,-0.069590375,0.0046788547,-0.01262769,0.00272814,0.034985896,-0.025339186,0.0015607253,-0.03743814,-0.046900287,-0.07570148,0.013036633,0.02746219,-0.088116415,-0.03387228,0.027824985,-0.020491779,-0.073911294,-0.06731412,-0.020590236,0.094756246,-0.002480313,-0.019432152,-0.067663886,-0.05068236,-0.03349537,0.008827647,0.021326864,-0.102286205,-0.06523758,0.06845277,0.030175367,-0.034087952,-0.016951699,0.044030044,0.0048587066,0.04557479,0.024102878,-0.06766731,0.0006189631,-0.0016289649,-0.0091125965,0.0025373662,0.064210005,0.060521547,0.019451525,0.044824235,0.03546299,0.00085114804,0.044316772,-0.02964135,0.022049988,0.08855262,-0.018993473,0.02045728,-0.036155213,-0.0638053,0.024004078,-0.028627701,-0.016457813,-0.008063047,-0.009908978,0.055812415,-0.04257519,-0.078953706,-0.041018896,-0.095089115,-0.026336899,-0.050019793,-0.0013337019,0.074392445,-0.061391115,0.07791912,0.0729081,-0.055466045,0.0036338784,-0.036030848,-0.04913656,-0.09111365,-0.03753965,0.024662826,0.06592681,0.07126894,0.05014932,-0.09037344,-0.024974756,0.043533877,-0.022623707,0.06986597,-0.059833154,-0.0364617,-0.003126804,0.028181264,-0.015513247,0.05535755,0.07270957,0.1030455,0.0042156084,0.023931533,-0.040923826,-0.066653535,-0.013333491,-0.0056750276,0.070362516,-0.0026687402,-0.04823212,-0.016626468,-0.064711966,-0.04602444,0.04649093,-0.005048159,0.019451346,-0.037954494,-0.005328016,0.026755035,-0.056326143,0.012190669,-0.013256872,-0.088740915,0.0034607933,-0.18603195,-0.0377934,-0.034112874,0.047847815,0.027396033,-0.0010202212,0.03583913,0.038012147,-0.091960125,-0.05836413,-0.027945107,0.05450341,-0.05306265,0.03861283,-0.047630515,0.030284287,0.059950985,-0.017707206,0.008364705,-0.01746819,0.058567893,0.05713025,0.028585475,0.04525191,-0.086038575,0.032432653,-0.033704143,0.038853623,0.036945093,-0.024117049,-0.08858414,-0.034382157,0.11731948,-0.01871009,-0.09266546,0.018281175,0.071285985,-0.00580346,0.06827369,0.00582207,0.041364025,0.016940061,0.007920265,-0.10011053,-0.0014081965,-0.008966284,-0.062248442,-0.007710681,0.0015506893,0.06532803,0.10317277,-0.079207554,0.011105999,0.05146991,-0.08434336,-0.06558965,-0.04850443,0.048408147,0.0064874724,-0.053109746,0.07559651,-0.0006720419,0.009459101,0.0038823388,0.070569776,0.06661029,-0.0022014068,0.040221803,-0.037839748,0.034349453,-0.039040253,-0.100961015,0.024425333,-0.045085438,-0.016629014,0.012357237,0.001958053,0.0064787637,0.022768503,-0.052067995,-0.06219237,-0.031566523,0.010839955,-0.033358082,-0.084370025,0.05194708,0.059898883,0.0043445416,0.09234734,0.082300335,0.0063214656,0.05556886,0.02073914,0.049402934,0.0041241013,0.005622279,-0.13245036,-0.059695695,0.09793672,1.771651e-33,-0.04078426,0.0006084636,0.034526695,0.09276466,-0.039429005,0.0072469017,0.07224635,0.11367711,0.07168404,0.047260188,-0.08702194,0.008337832,-0.03541893,0.026326757,-0.01025128,-0.035566907,0.08090127,-0.010691205,-0.047601845,-0.01793492,0.092496365,0.058194876,0.037165396,0.014347228,-0.013966248,-0.0019126221,-0.025646076,-0.03267979,-0.035171878,0.022591224,-0.0006061803,-0.013648737,0.01783049,0.15121643,0.009420795,-0.01309102,0.042238664,0.072726905,0.105856664,0.060776737,-0.08935368,-0.00023830304,0.0086474875,0.02567483,0.049235534,-0.018539334,-0.010566939,-0.048976358,-0.018474834,-0.01074711,0.11925163,0.06569921,0.039849967,0.01725768,-0.08966146,0.0031284594,-0.013421795,-0.06911806,0.008284207,-0.027460303,0.047884256,-0.014182078,-0.030034497,0.0254011,-0.023311278,0.105511874,0.07715039,-0.026345156,0.018426487,0.04575511,-0.0121683655,-0.062416017,0.015642097,-0.05570724,0.07089752,0.026572652,0.081793115,-0.027508074,0.01759909,0.03457655,-0.04173289,-0.044656616,0.10007307,0.015977891,0.063004136,-0.06129697,-0.05448865,-0.078779094,-0.023586709,-0.027603885,-0.02680423,-0.08723074,0.0660487,-0.05705908,-0.055665758,-3.461936e-33,-0.022343155,-0.013923654,-0.0018097048,0.043464042,-0.022106461,-0.0118518965,0.04771786,0.0010212637,-0.046223078,0.05273467,0.016614707,0.02059928,0.02003818,0.017798223,0.0058313874,0.028632022,0.058052372,0.007489559,0.04057181,-0.061787706,-0.0063771764,0.096199475,0.0105233975,-0.06111004,0.0010911338,0.013656114,0.034399174,0.093972005,-0.022421202,-0.008697582,-0.02701014,-0.06978507,-0.026796767,0.025645958,-0.04920561,0.007238312,0.02037883,0.010970829,-0.013878013,-0.0126279425,0.04690171,-0.005296332,-0.016946217,-0.036907844,0.088059925,0.08430213,-0.13925071,-0.11479056,-0.044022374,0.089878194,0.09483482,0.0020300266,0.033296973,0.02108489,-0.04112819,-0.08890007,0.092768386,-0.0095710615,-0.006409119,0.055996954,0.0139835365,-0.029365463,-0.0146134645,0.0018498227]') as cosine_similarity
    # FROM embeddings
    # ORDER BY cosine_similarity DESC
    # LIMIT 2;

    return []
